<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Reports & PDF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- PROFESSIONAL DARK THEME --- */
    :root { 
      --bg: #0f172a; 
      --card: #1e293b; 
      --primary: #10b981; /* Green */
      --secondary: #0ea5e9; /* Blue */
      --danger: #ef4444; 
      --text: #f8fafc; 
      --text-muted: #94a3b8;
      --border: #334155; 
    }
    
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; padding-bottom: 50px; }

    /* Nav */
    nav { 
      background: var(--card); padding: 15px 20px; border-bottom: 1px solid var(--border); 
      display: flex; gap: 10px; overflow-x: auto;
    }
    nav a { 
      color: var(--text-muted); text-decoration: none; padding: 8px 16px; border-radius: 6px; 
      font-size: 0.9rem; white-space: nowrap; transition: 0.2s;
    }
    nav a:hover { background: #2d3748; color: white; }
    nav a.active { background: rgba(14, 165, 233, 0.15); color: var(--secondary); font-weight: 600; }

    /* Layout */
    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

    /* Analytics Section */
    .analytics-panel {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;
      animation: fadeIn 0.5s ease;
    }
    .stat-box { 
      background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border);
      display: flex; flex-direction: column; justify-content: center; text-align: center;
    }
    .stat-box h3 { margin: 0 0 5px 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; }
    .stat-box p { margin: 0; font-size: 2rem; font-weight: 700; color: #fff; }
    
    .chart-container { 
      background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border);
      height: 200px; display: flex; justify-content: center; align-items: center;
    }

    /* Search Bar */
    .search-section {
      background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border);
      display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .input-group { flex: 1; min-width: 250px; position: relative; }
    input { 
      width: 100%; padding: 12px 15px; padding-left: 40px; background: #0f172a; 
      border: 1px solid var(--border); color: white; border-radius: 8px; box-sizing: border-box;
    }
    .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.6; }

    button { 
      padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .btn-search { background: var(--secondary); color: white; }
    .btn-search:hover { filter: brightness(1.1); }
    
    .btn-load { background: var(--card); border: 1px solid var(--border); color: var(--text-muted); }
    .btn-load:hover { background: var(--border); color: white; }
    
    .btn-all { background: rgba(16, 185, 129, 0.1); color: var(--primary); border: 1px solid var(--primary); }
    .btn-all:hover { background: var(--primary); color: #000; }

    /* Customer Card */
    .cust-card { 
      background: var(--card); border: 1px solid var(--border); border-radius: 12px; 
      overflow: hidden; margin-bottom: 20px; animation: fadeIn 0.3s ease;
    }
    
    .card-header { 
      background: rgba(255,255,255,0.03); padding: 15px 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
    }
    .header-info h2 { margin: 0; font-size: 1.2rem; color: #fff; }
    .header-info span { font-size: 0.9rem; color: var(--secondary); }
    .header-meta { font-size: 0.9rem; color: var(--text-muted); text-align: right; }

    /* Product Section */
    .product-section { padding: 20px; border-bottom: 1px solid var(--border); }
    .product-section:last-child { border-bottom: none; }
    
    .prod-title { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; font-size: 1rem; }
    .badges { display: flex; gap: 10px; font-size: 0.9rem; margin-bottom: 15px; }
    .badge { padding: 4px 10px; border-radius: 4px; background: #334155; color: #cbd5e1; }
    .badge.bal { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
    .badge.paid { background: rgba(16, 185, 129, 0.2); color: var(--primary); }

    /* History Table */
    .history-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .history-table th { text-align: left; color: var(--text-muted); padding: 8px; border-bottom: 1px solid var(--border); }
    .history-table td { padding: 8px; border-bottom: 1px solid #334155; color: #e2e8f0; }
    .history-table tr:last-child td { border-bottom: none; }

    /* PDF Button */
    .pdf-actions { padding: 15px 20px; background: rgba(0,0,0,0.2); display: flex; justify-content: flex-end; }
    .btn-pdf { background: var(--danger); color: white; font-size: 0.9rem; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    @media(max-width: 768px) {
      .card-header { flex-direction: column; align-items: flex-start; }
      .header-meta { text-align: left; }
      .analytics-panel { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html">Dashboard</a>
    <a href="customers.html">Customers</a>
    <a href="entries.html">Entries</a>
    <a href="review.html">Review</a>
    <a href="reports.html" class="active">Reports</a>
  </nav>

  <div class="container">
    
    <div class="analytics-panel">
      <div style="display:flex; flex-direction:column; gap:10px;">
        <div class="stat-box">
          <h3>Total Paid</h3>
          <p id="dispTotalPaid" style="color:var(--primary)">‚Çπ0</p>
        </div>
        <div class="stat-box">
          <h3>Total Outstanding</h3>
          <p id="dispTotalBal" style="color:var(--danger)">‚Çπ0</p>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="financeChart"></canvas>
      </div>
    </div>

    <div class="search-section">
      <div class="input-group">
        <span class="icon">üîç</span>
        <input id="searchInput" placeholder="Search Name, ID or Phone..." onkeyup="localFilter()">
      </div>
      <button class="btn-search" onclick="searchCloud()">‚òÅÔ∏è Search Cloud</button>
      <button class="btn-load" onclick="loadRecent(20)">üîÑ Load Recent</button>
      <button class="btn-all" onclick="loadAllData()">üìÇ Load ALL Data</button>
    </div>

    <div id="resultsArea">
      <div style="text-align:center; padding: 60px; color: #64748b;">
        <p>Enter details above or click "Load Recent" to view reports.</p>
      </div>
    </div>

  </div>

  <script type="module">
    import { db } from "./config.js";
    import { collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    let loadedCustomers = [];
    let chartInstance = null;

    // --- 1. LOAD RECENT (Default 20) ---
    window.loadRecent = async (limitCount) => {
      const container = document.getElementById("resultsArea");
      container.innerHTML = `<p style="text-align:center; color:#aaa;">Loading recent data...</p>`;

      try {
        const q = query(collection(db, "customers"), orderBy("createdAt", "desc"), limit(limitCount));
        const snapshot = await getDocs(q);
        
        loadedCustomers = [];
        snapshot.forEach(doc => loadedCustomers.push(doc.data()));
        
        renderList(loadedCustomers);
      } catch (e) {
        console.error(e);
        container.innerHTML = `<p style="text-align:center; color:#ef4444;">Error loading data.</p>`;
      }
    };

    // --- 2. LOAD ALL DATA ---
    window.loadAllData = async () => {
      if(!confirm("‚ö†Ô∏è Load ALL customers? This may take time and consume data reads.")) return;
      
      const container = document.getElementById("resultsArea");
      container.innerHTML = `<p style="text-align:center; color:#secondary;">Fetching ALL records...</p>`;

      try {
        // Warning: Unbounded query
        const q = collection(db, "customers");
        const snapshot = await getDocs(q);
        
        loadedCustomers = [];
        snapshot.forEach(doc => loadedCustomers.push(doc.data()));
        
        renderList(loadedCustomers);
      } catch (e) {
        alert("Error: " + e.message);
      }
    };

    // --- 3. SEARCH CLOUD ---
    window.searchCloud = async () => {
      const term = document.getElementById("searchInput").value.trim();
      if (!term) return alert("Please enter an ID or Name to search.");

      const container = document.getElementById("resultsArea");
      container.innerHTML = `<p style="text-align:center; color:#aaa;">Searching Cloud Database...</p>`;

      try {
        const q = query(
          collection(db, "customers"),
          where("id", ">=", term),
          where("id", "<=", term + '\uf8ff'),
          limit(10)
        );

        const snapshot = await getDocs(q);
        loadedCustomers = [];
        snapshot.forEach(doc => loadedCustomers.push(doc.data()));

        if (loadedCustomers.length === 0) {
          container.innerHTML = `<p style="text-align:center; color:#aaa;">No results found for "${term}".</p>`;
        } else {
          renderList(loadedCustomers);
        }
      } catch (e) {
        alert("Search Error: " + e.message);
      }
    };

    // --- 4. LOCAL FILTER ---
    window.localFilter = () => {
      const term = document.getElementById("searchInput").value.toLowerCase();
      if (!term) return renderList(loadedCustomers);

      const filtered = loadedCustomers.filter(c => 
        (c.name && c.name.toLowerCase().includes(term)) ||
        (c.id && c.id.toLowerCase().includes(term)) ||
        (c.phone && c.phone.includes(term))
      );
      renderList(filtered);
    };

    // --- 5. RENDER UI & UPDATE STATS ---
    function renderList(data) {
      const container = document.getElementById("resultsArea");
      container.innerHTML = "";

      // Global Accumulators
      let totalPaidAll = 0;
      let totalBalAll = 0;

      if (data.length === 0) {
        container.innerHTML = `<p style="text-align:center; color:#aaa;">No records available.</p>`;
        updateCharts(0, 0);
        return;
      }

      data.forEach(c => {
        let productsHTML = "";

        c.products.forEach(p => {
          const totalCost = parseFloat(p.total || 0);
          const payments = p.payments || [];
          
          // Sort payments by Due Number
          payments.sort((a,b) => (a.dueNumber || 0) - (b.dueNumber || 0));

          // Generate Transaction Rows & Running Balance
          let historyRows = "";
          let runningPaid = 0; // Cumulative paid for this product
          
          if (payments.length === 0) {
            historyRows = `<tr><td colspan="5" style="text-align:center; color:#666;">No payments yet</td></tr>`;
          } else {
            payments.forEach(pay => {
              const amt = parseFloat(pay.amount || 0);
              runningPaid += amt;
              const currentBalance = totalCost - runningPaid; // Running Balance Logic

              const dueDisplay = pay.dueNumber ? `#${pay.dueNumber}` : '-';
              
              historyRows += `
                <tr>
                  <td>${dueDisplay}</td>
                  <td>${pay.date}</td>
                  <td style="color:var(--primary);">‚Çπ${amt.toLocaleString()}</td>
                  <td style="color:#aaa;">‚Çπ${currentBalance.toLocaleString()}</td>
                  <td style="font-size:0.8em; color:#888;">${pay.type || 'Manual'}</td>
                </tr>
              `;
            });
          }

          const currentPaid = runningPaid;
          const currentBal = totalCost - runningPaid;

          // Add to Global Totals
          totalPaidAll += currentPaid;
          totalBalAll += currentBal;

          productsHTML += `
            <div class="product-section">
              <div class="prod-title">
                <span>üì¶ ${p.name}</span>
                <span>Value: ‚Çπ${totalCost.toLocaleString()}</span>
              </div>
              
              <div class="badges">
                <div class="badge paid">Paid: ‚Çπ${currentPaid.toLocaleString()}</div>
                <div class="badge bal">Bal: ‚Çπ${currentBal.toLocaleString()}</div>
              </div>

              <details>
                <summary style="cursor:pointer; color:var(--secondary); font-size:0.9rem; margin-bottom:10px;">View Ledger (History)</summary>
                <table class="history-table">
                  <thead>
                    <tr>
                      <th width="10%">Due</th>
                      <th width="25%">Date</th>
                      <th width="25%">Amount</th>
                      <th width="25%">Balance</th>
                      <th>Type</th>
                    </tr>
                  </thead>
                  <tbody>${historyRows}</tbody>
                </table>
              </details>
            </div>
          `;
        });

        // Customer Card
        const card = document.createElement("div");
        card.className = "cust-card";
        card.innerHTML = `
          <div class="card-header">
            <div class="header-info">
              <h2>${c.name}</h2>
              <span>ID: ${c.id}</span>
            </div>
            <div class="header-meta">
              üìû ${c.phone || 'N/A'} <br>
              üìç ${c.place || 'N/A'}
            </div>
          </div>
          
          ${productsHTML}

          <div class="pdf-actions">
            <button class="btn-pdf" onclick='generatePDF(${JSON.stringify(c).replace(/'/g, "&apos;")})'>
              üìÑ Download Statement PDF
            </button>
          </div>
        `;
        container.appendChild(card);
      });

      // Update Global Stats UI
      document.getElementById("dispTotalPaid").innerText = "‚Çπ" + totalPaidAll.toLocaleString();
      document.getElementById("dispTotalBal").innerText = "‚Çπ" + totalBalAll.toLocaleString();
      
      updateCharts(totalPaidAll, totalBalAll);
    }

    // --- 6. CHART.JS VISUALS ---
    function updateCharts(paid, balance) {
      const ctx = document.getElementById("financeChart").getContext('2d');
      if (chartInstance) chartInstance.destroy();

      
      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Total Paid', 'Outstanding'],
          datasets: [{
            data: [paid, balance],
            backgroundColor: ['#10b981', '#ef4444'],
            borderColor: '#1e293b',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { color: '#94a3b8' } }
          }
        }
      });
    }

    // --- 7. GENERATE PROFESSIONAL PDF ---
    window.generatePDF = (c) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Header
      doc.setFillColor(15, 23, 42); 
      doc.rect(0, 0, 210, 40, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(22);
      doc.text("Statement of Account", 14, 20);
      
      doc.setFontSize(10);
      doc.setTextColor(200, 200, 200);
      doc.text("Meena Groups | EMI Manager", 14, 28);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 28);

      // Customer Info
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(12);
      doc.text(`Customer: ${c.name}`, 14, 55);
      doc.text(`ID: ${c.id}`, 14, 62);
      doc.text(`Phone: ${c.phone || '-'}`, 120, 55);
      doc.text(`Place: ${c.place || '-'}`, 120, 62);

      let finalY = 75;

      // Loop Products
      c.products.forEach(p => {
        const total = parseFloat(p.total || 0);
        let runningPaid = 0;
        
        // Prepare PDF Table Rows with Running Balance
        const tableBody = (p.payments || []).sort((a,b) => (a.dueNumber||0)-(b.dueNumber||0)).map(pay => {
          const amt = parseFloat(pay.amount);
          runningPaid += amt;
          const currentBal = total - runningPaid;
          
          return [
            `#${pay.dueNumber || '-'}`,
            pay.date,
            pay.type || 'Payment',
            `Rs. ${amt.toLocaleString()}`,
            `Rs. ${currentBal.toLocaleString()}`
          ];
        });

        const finalBalance = total - runningPaid;

        // Product Header
        doc.setFontSize(14);
        doc.setTextColor(14, 165, 233);
        doc.text(`Product: ${p.name}`, 14, finalY);
        
        doc.setFontSize(10);
        doc.setTextColor(80, 80, 80);
        doc.text(`Total Value: Rs.${total.toLocaleString()}   |   Paid: Rs.${runningPaid.toLocaleString()}   |   Final Balance: Rs.${finalBalance.toLocaleString()}`, 14, finalY + 7);

        // Render Table
        doc.autoTable({
          startY: finalY + 12,
          head: [['Due #', 'Date', 'Type', 'Amount', 'Balance']],
          body: tableBody,
          theme: 'striped',
          headStyles: { fillColor: [15, 23, 42] },
          styles: { fontSize: 10 },
          margin: { left: 14, right: 14 }
        });

        finalY = doc.lastAutoTable.finalY + 20;
      });

      doc.setFontSize(8);
      doc.setTextColor(150);
      doc.text("Generated by Meena Groups System", 14, 290);

      doc.save(`Statement_${c.name}_${c.id}.pdf`);
    };

    // Load initial list
    loadRecent(20);
  </script>
</body>
</html>
