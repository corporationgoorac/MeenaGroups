<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - EMI Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- PROFESSIONAL DASHBOARD THEME --- */
    :root { 
      --bg: #0f172a; 
      --card: #1e293b; 
      --primary: #10b981; /* Emerald */
      --secondary: #0ea5e9; /* Sky Blue */
      --purple: #8b5cf6;
      --danger: #ef4444; 
      --text: #f8fafc; 
      --text-muted: #94a3b8;
      --border: #334155; 
    }
    
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }

    /* Navigation */
    nav { 
      background: var(--card); padding: 15px 20px; border-bottom: 1px solid var(--border); 
      display: flex; gap: 10px; overflow-x: auto;
    }
    nav a { 
      color: var(--text-muted); text-decoration: none; padding: 8px 16px; border-radius: 6px; 
      font-size: 0.9rem; white-space: nowrap; transition: 0.2s;
    }
    nav a:hover { background: #2d3748; color: white; }
    nav a.active { background: rgba(16, 185, 129, 0.15); color: var(--primary); font-weight: 600; }

    /* Main Container */
    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

    /* Header */
    .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header-section h1 { margin: 0; font-size: 1.8rem; }
    .header-section p { margin: 5px 0 0; color: var(--text-muted); }

    .btn-refresh { 
      background: var(--card); border: 1px solid var(--border); color: var(--text); 
      padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .btn-refresh:hover { background: var(--border); }

    /* Stats Grid */
    .stats-grid { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
      gap: 20px; margin-bottom: 40px; 
    }
    
    .stat-card { 
      background: var(--card); padding: 25px; border-radius: 16px; 
      border: 1px solid var(--border); position: relative; overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* Decorative top bars */
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
    .stat-card.c-blue::before { background: var(--secondary); }
    .stat-card.c-purple::before { background: var(--purple); }
    .stat-card.c-green::before { background: var(--primary); }
    .stat-card.c-red::before { background: var(--danger); }

    .stat-card h3 { margin: 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card p { margin: 10px 0 0; font-size: 2rem; font-weight: 700; color: white; }
    
    /* Content Layout (Chart + Actions) */
    .dashboard-content { 
      display: grid; grid-template-columns: 2fr 1fr; gap: 30px; 
    }

    /* Chart Section */
    .chart-box { 
      background: var(--card); padding: 25px; border-radius: 16px; 
      border: 1px solid var(--border); height: 350px; position: relative;
    }

    /* Quick Actions */
    .actions-box { display: flex; flex-direction: column; gap: 15px; }
    
    .action-btn { 
      background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px;
      text-decoration: none; color: white; display: flex; align-items: center; gap: 15px;
      transition: transform 0.2s, background 0.2s;
    }
    .action-btn:hover { transform: translateY(-3px); background: #252e42; border-color: var(--secondary); }
    
    .icon-box { 
      width: 50px; height: 50px; background: rgba(255,255,255,0.05); border-radius: 10px;
      display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .dashboard-content { grid-template-columns: 1fr; }
      .chart-box { height: 300px; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html" class="active">Dashboard</a>
    <a href="customers.html">Customers</a>
    <a href="entries.html">Entries</a>
    <a href="review.html">Agent Sync</a>
    <a href="report.html">Reports</a>
  </nav>

  <div class="container">
    
    <div class="header-section">
      <div>
        <h1>Dashboard</h1>
        <p>Overview of your EMI business performance.</p>
      </div>
      <button class="btn-refresh" onclick="loadDashboard()">üîÑ Refresh</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card c-blue">
        <h3>Total Customers</h3>
        <p id="totalCustomers">-</p>
      </div>
      <div class="stat-card c-purple">
        <h3>Products Sold</h3>
        <p id="totalProducts">-</p>
      </div>
      <div class="stat-card c-green">
        <h3>Total Collected</h3>
        <p id="totalPaid" style="color:var(--primary)">-</p>
      </div>
      <div class="stat-card c-red">
        <h3>Total Outstanding</h3>
        <p id="totalBalance" style="color:var(--danger)">-</p>
      </div>
    </div>

    <div class="dashboard-content">
      
      <div class="chart-box">
        <canvas id="mainChart"></canvas>
      </div>

      <div class="actions-box">
        <h3 style="margin:0 0 10px 0; color:var(--text-muted);">Quick Actions</h3>
        
        <a href="customers.html" class="action-btn">
          <div class="icon-box" style="color:var(--secondary)">üë§</div>
          <div>
            <strong>New Customer</strong><br>
            <small style="color:var(--text-muted)">Add profile & products</small>
          </div>
        </a>

        <a href="entries.html" class="action-btn">
          <div class="icon-box" style="color:var(--primary)">üí∞</div>
          <div>
            <strong>Add Payment</strong><br>
            <small style="color:var(--text-muted)">Log manual collection</small>
          </div>
        </a>

        <a href="review.html" class="action-btn">
          <div class="icon-box" style="color:var(--purple)">üõ°Ô∏è</div>
          <div>
            <strong>Review Agents</strong><br>
            <small style="color:var(--text-muted)">Approve daily collections</small>
          </div>
        </a>
      </div>

    </div>

  </div>

  <script type="module">
    import { db } from "./config.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    let chartInstance = null;

    // --- 1. LOAD STATS ---
    window.loadDashboard = async () => {
      const btn = document.querySelector(".btn-refresh");
      btn.innerText = "Loading...";
      btn.disabled = true;

      try {
        // Read "metadata/stats" document (Single read = Cheap!)
        const docRef = doc(db, "metadata", "stats");
        const snap = await getDoc(docRef);

        let data = { totalCustomers: 0, totalProducts: 0, totalPaid: 0, totalBalance: 0 };
        
        if (snap.exists()) {
          data = snap.data();
        } else {
          console.warn("Stats not initialized yet. Add a customer to start.");
        }

        // Update Text
        document.getElementById("totalCustomers").innerText = (data.totalCustomers || 0).toLocaleString();
        document.getElementById("totalProducts").innerText = (data.totalProducts || 0).toLocaleString();
        document.getElementById("totalPaid").innerText = "‚Çπ" + (data.totalPaid || 0).toLocaleString();
        document.getElementById("totalBalance").innerText = "‚Çπ" + (data.totalBalance || 0).toLocaleString();

        // Update Chart
        renderChart(data.totalPaid || 0, data.totalBalance || 0);

      } catch (e) {
        console.error("Dashboard Error:", e);
        alert("Could not load dashboard stats.");
      } finally {
        btn.innerText = "üîÑ Refresh";
        btn.disabled = false;
      }
    };

    // --- 2. RENDER CHART ---
    function renderChart(paid, balance) {
      const ctx = document.getElementById("mainChart").getContext('2d');
      
      if (chartInstance) chartInstance.destroy();

      // 
      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Collected', 'Outstanding'],
          datasets: [{
            data: [paid, balance],
            backgroundColor: ['#10b981', '#ef4444'], // Green & Red
            borderColor: '#1e293b', // Match card bg
            borderWidth: 6,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '75%', // Thinner ring
          plugins: {
            legend: { 
              position: 'bottom', 
              labels: { color: '#94a3b8', padding: 20, font: { size: 14 } } 
            },
            title: { 
              display: true, 
              text: 'Revenue Distribution', 
              color: '#f8fafc', 
              font: { size: 16, weight: 'normal' },
              padding: { bottom: 20 }
            }
          }
        }
      });
    }

    // Load on startup
    loadDashboard();
  </script>
</body>
</html>

