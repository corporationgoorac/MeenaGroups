<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Review - Meena Groups</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- PROFESSIONAL DARK ADMIN THEME --- */
    :root { 
      --bg: #0f172a; 
      --card: #1e293b; 
      --primary: #10b981; 
      --secondary: #06b6d4; 
      --danger: #ef4444; 
      --warning: #f59e0b;
      --text: #f1f5f9; 
      --text-muted: #94a3b8;
      --border: #334155; 
      --input-bg: #0f172a;
    }
    
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }

    /* Navigation */
    nav { 
      background: var(--card); padding: 15px 20px; border-bottom: 1px solid var(--border); 
      display: flex; gap: 10px; overflow-x: auto;
    }
    nav a { 
      color: var(--text-muted); text-decoration: none; padding: 8px 16px; border-radius: 6px; 
      font-size: 0.9rem; white-space: nowrap; transition: 0.2s;
    }
    nav a:hover { background: #2d3748; color: white; }
    nav a.active { background: rgba(6, 182, 212, 0.15); color: var(--secondary); font-weight: 600; }

    /* Layout */
    .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }

    /* Header */
    .header-section { 
      display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; 
      flex-wrap: wrap; gap: 20px;
    }
    .header-text h1 { margin: 0; font-size: 1.8rem; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .stats-card {
      background: var(--card); border: 1px solid var(--border); padding: 15px 25px; 
      border-radius: 12px; text-align: right;
    }
    .stats-card strong { font-size: 1.8rem; color: var(--primary); display: block; }
    .stats-card span { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; }

    /* Card List */
    .review-list { display: flex; flex-direction: column; gap: 15px; }

    .entry-item {
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      padding: 20px; display: grid; grid-template-columns: 1.5fr 1fr 1fr auto;
      align-items: center; gap: 20px; position: relative; transition: all 0.2s ease;
    }
    .entry-item:hover { border-color: var(--text-muted); transform: translateY(-2px); }

    /* Columns */
    .col-info h4 { margin: 0; font-size: 1.1rem; color: #fff; }
    .col-info p { margin: 4px 0 0; color: var(--text-muted); font-size: 0.9rem; }
    
    .col-meta { display: flex; flex-direction: column; gap: 5px; }
    .tag { background: #334155; color: #cbd5e1; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; width: fit-content; }
    
    .due-tag { 
      color: var(--secondary); font-weight: bold; font-size: 0.9rem; 
      background: rgba(6, 182, 212, 0.1); padding: 2px 8px; border-radius: 4px; width: fit-content;
    }

    .col-amount { text-align: right; }
    .amount-display { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
    .date-display { font-size: 0.85rem; color: var(--text-muted); }

    .col-actions { display: flex; gap: 8px; }

    /* Action Buttons */
    .btn-icon {
      width: 38px; height: 38px; border-radius: 8px; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: 0.2s;
    }
    .btn-edit { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .btn-edit:hover { background: var(--warning); color: black; }
    
    .btn-accept { background: rgba(16, 185, 129, 0.2); color: var(--primary); }
    .btn-accept:hover { background: var(--primary); color: black; }
    
    .btn-reject { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .btn-reject:hover { background: var(--danger); color: white; }

    /* Approve All Button */
    .btn-approve-all {
      background: var(--secondary); color: #000; border: none; padding: 12px 24px;
      border-radius: 8px; font-weight: 600; cursor: pointer;
    }
    .btn-approve-all:disabled { opacity: 0.5; cursor: not-allowed; }

    /* --- EDIT MODAL --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal {
      background: var(--card); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px;
      border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .modal h3 { margin-top: 0; color: var(--secondary); }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 5px; }
    .form-group input { 
      width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border); 
      color: white; border-radius: 6px; box-sizing: border-box;
    }
    
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn-modal { flex: 1; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
    .btn-cancel { background: #334155; color: white; }
    .btn-save { background: var(--primary); color: black; }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .entry-item { grid-template-columns: 1fr; gap: 15px; text-align: left; }
      .col-amount { text-align: left; display: flex; justify-content: space-between; align-items: center; }
      .col-actions { justify-content: space-between; }
      .btn-icon { flex: 1; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html">Dashboard</a>
    <a href="customers.html">Customers</a>
    <a href="entries.html">Entries</a>
    <a href="review.html" class="active">Review</a>
    <a href="report.html">Reports</a>
  </nav>

  <div class="container">
    <div class="header-section">
      <div class="header-text">
        <h1>Admin Approvals</h1>
        <p>Review and sync agent collections.</p>
      </div>
      <div class="stats-card">
        <span>Total Pending</span>
        <strong id="totalPendingAmt">â‚¹0</strong>
      </div>
      <button class="btn-approve-all" onclick="approveAll()">âœ… Approve All</button>
    </div>

    <div id="reviewList" class="review-list">
      <div style="text-align:center; padding: 40px; color:#666;">Loading...</div>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h3>âœŽ Edit Entry</h3>
      <input type="hidden" id="editDocId">
      
      <div class="form-group">
        <label>Amount (â‚¹)</label>
        <input type="number" id="editAmount">
      </div>
      
      <div class="form-group">
        <label>Due Number</label>
        <input type="number" id="editDueNumber">
      </div>

      <div class="form-group">
        <label>Date</label>
        <input type="date" id="editDate">
      </div>

      <div class="modal-actions">
        <button class="btn-modal btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="btn-modal btn-save" onclick="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./config.js";
    import { 
      collection, query, where, getDocs, doc, runTransaction, increment, deleteDoc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    let pendingEntries = [];

    // --- 1. LOAD DATA ---
    async function loadPending() {
      const listDiv = document.getElementById("reviewList");
      const totalDisplay = document.getElementById("totalPendingAmt");
      const approveAllBtn = document.querySelector(".btn-approve-all");

      try {
        const q = query(collection(db, "temp_entries"), where("status", "==", "pending"));
        const snapshot = await getDocs(q);
        
        pendingEntries = [];
        let totalAmt = 0;

        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          d.docId = docSnap.id;
          d.jsDate = d.timestamp ? (d.timestamp.toDate ? d.timestamp.toDate() : new Date(d.timestamp)) : new Date();
          pendingEntries.push(d);
          totalAmt += parseFloat(d.amount || 0);
        });

        // Sort Newest First
        pendingEntries.sort((a, b) => b.jsDate - a.jsDate);

        totalDisplay.innerText = "â‚¹" + totalAmt.toLocaleString();
        listDiv.innerHTML = "";

        if (pendingEntries.length === 0) {
          listDiv.innerHTML = `<div style="text-align:center; padding:60px; color:#64748b;">
            <h2 style="margin:0;">ðŸŽ‰</h2><p>No pending collections.</p>
          </div>`;
          approveAllBtn.disabled = true;
          return;
        }

        approveAllBtn.disabled = false;

        pendingEntries.forEach(d => {
          // Display Due Number logic
          const dueDisplay = (d.dueNumber && d.dueNumber > 0) ? `#${d.dueNumber}` : 'Auto (Next)';

          const card = document.createElement("div");
          card.className = "entry-item";
          card.id = `card-${d.docId}`;
          
          card.innerHTML = `
            <div class="col-info">
              <h4>${d.customerName}</h4>
              <p>ID: ${d.customerId}</p>
            </div>
            
            <div class="col-meta">
              <span class="tag">ðŸ“¦ ${d.productName}</span>
              <span class="due-tag">Due: ${dueDisplay}</span>
            </div>

            <div class="col-amount">
              <div class="amount-display">â‚¹${d.amount}</div>
              <div class="date-display">ðŸ“… ${d.date}</div>
            </div>

            <div class="col-actions">
              <button class="btn-icon btn-edit" onclick="openEdit('${d.docId}')" title="Edit">âœŽ</button>
              <button class="btn-icon btn-reject" onclick="rejectEntry('${d.docId}')" title="Reject">âœ•</button>
              <button class="btn-icon btn-accept" onclick="approveEntry('${d.docId}')" title="Approve">âœ“</button>
            </div>
          `;
          listDiv.appendChild(card);
        });

      } catch (e) {
        console.error(e);
        listDiv.innerHTML = `<p style="color:#ef4444; text-align:center;">Error: ${e.message}</p>`;
      }
    }

    // --- 2. EDIT MODAL LOGIC ---
    window.openEdit = (docId) => {
      const entry = pendingEntries.find(e => e.docId === docId);
      if (!entry) return;

      document.getElementById("editDocId").value = docId;
      document.getElementById("editAmount").value = entry.amount;
      document.getElementById("editDate").value = entry.date;
      document.getElementById("editDueNumber").value = entry.dueNumber || 0; // Default 0 if missing

      document.getElementById("editModal").style.display = "flex";
    };

    window.closeModal = () => {
      document.getElementById("editModal").style.display = "none";
    };

    window.saveEdit = async () => {
      const docId = document.getElementById("editDocId").value;
      const newAmt = parseFloat(document.getElementById("editAmount").value);
      const newDate = document.getElementById("editDate").value;
      const newDue = parseInt(document.getElementById("editDueNumber").value);

      if(!newAmt || !newDate) return alert("Invalid inputs");

      const btn = document.querySelector(".btn-save");
      btn.innerText = "Saving...";

      try {
        const ref = doc(db, "temp_entries", docId);
        
        await updateDoc(ref, {
          amount: newAmt,
          date: newDate,
          dueNumber: newDue // Updates value in DB
        });

        closeModal();
        loadPending(); // Refresh UI
        btn.innerText = "Save Changes";

      } catch (e) {
        alert("Error updating: " + e.message);
        btn.innerText = "Save Changes";
      }
    };

    // --- 3. APPROVE LOGIC ---
    window.approveEntry = async (docId) => {
      const entry = pendingEntries.find(e => e.docId === docId);
      if (!entry) return;

      const card = document.getElementById(`card-${docId}`);
      card.style.opacity = "0.5"; card.style.pointerEvents = "none";

      try {
        await runTransaction(db, async (transaction) => {
          const custRef = doc(db, "customers", entry.customerId);
          const statsRef = doc(db, "metadata", "stats");
          const tempRef = doc(db, "temp_entries", docId);

          const custDoc = await transaction.get(custRef);
          if (!custDoc.exists()) throw `Customer ${entry.customerId} not found!`;

          const data = custDoc.data();
          
          // Find Product
          let pIndex = entry.productIndex;
          // Verify
          if (!data.products[pIndex] || data.products[pIndex].name !== entry.productName) {
            pIndex = data.products.findIndex(p => p.name === entry.productName);
          }
          if (pIndex === -1) throw "Product mismatch - cannot merge.";

          const product = data.products[pIndex];

          // --- LOGIC: USE SPECIFIC DUE NUMBER ---
          let finalDue = entry.dueNumber; 
          
          // Safety: If somehow 0/null, calculate next available
          if (!finalDue || finalDue <= 0) {
             const max = (product.payments || []).length > 0 
               ? Math.max(...product.payments.map(p => p.dueNumber || 0)) 
               : 0;
             finalDue = max + 1;
          }

          const newPayment = {
            date: entry.date,
            amount: entry.amount,
            dueNumber: parseInt(finalDue), // Ensure it's a number
            type: "Agent Collection",
            approvedAt: new Date().toISOString()
          };

          if (!product.payments) product.payments = [];
          product.payments.push(newPayment);
          product.paid += entry.amount;

          // Commit
          transaction.update(custRef, { products: data.products });
          transaction.update(statsRef, {
            totalPaid: increment(entry.amount),
            totalBalance: increment(-entry.amount)
          });
          transaction.delete(tempRef);
        });

        // Remove from UI
        card.style.transform = "translateX(50px)";
        card.style.opacity = "0";
        setTimeout(() => { card.remove(); checkEmpty(); }, 300);

      } catch (e) {
        alert("Approval Failed: " + e);
        card.style.opacity = "1"; card.style.pointerEvents = "auto";
      }
    };

    // --- 4. REJECT LOGIC ---
    window.rejectEntry = async (docId) => {
      if(!confirm("Permanently delete this entry?")) return;
      try {
        await deleteDoc(doc(db, "temp_entries", docId));
        document.getElementById(`card-${docId}`).remove();
        checkEmpty();
      } catch (e) {
        alert("Error: " + e.message);
      }
    };

    // --- 5. APPROVE ALL ---
    window.approveAll = async () => {
      if (pendingEntries.length === 0) return;
      if (!confirm(`Approve all ${pendingEntries.length} entries?`)) return;

      const btn = document.querySelector(".btn-approve-all");
      btn.innerText = "Processing...";
      btn.disabled = true;

      for (const entry of pendingEntries) {
        if(document.getElementById(`card-${entry.docId}`)) {
          await window.approveEntry(entry.docId);
        }
      }
      
      btn.innerText = "âœ… Approve All";
      setTimeout(() => loadPending(), 1000);
    };

    function checkEmpty() {
      const remaining = document.querySelectorAll(".entry-item");
      if(remaining.length === 0) loadPending();
    }

    // Init
    loadPending();
    
    // Exports
    window.openEdit = openEdit;
    window.closeModal = closeModal;
    window.saveEdit = saveEdit;
    window.rejectEntry = rejectEntry;
    window.approveEntry = approveEntry;
    window.approveAll = approveAll;
  </script>
</body>
</html>

