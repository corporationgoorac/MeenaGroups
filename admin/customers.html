<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customer Management - EMI Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    /* --- PROFESSIONAL DARK THEME (MOBILE OPTIMIZED) --- */
    :root { 
      --bg: #0f172a; 
      --card: #1e293b; 
      --input: #0f172a;
      --primary: #10b981; /* Emerald */
      --secondary: #0ea5e9; /* Sky Blue */
      --danger: #ef4444; 
      --text: #f8fafc; 
      --text-muted: #94a3b8;
      --border: #334155; 
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; padding-bottom: 40px; }

    /* Navigation - Scrollable on Mobile */
    nav { 
      background: var(--card); padding: 15px; border-bottom: 1px solid var(--border); 
      display: flex; gap: 10px; overflow-x: auto; position: sticky; top: 0; z-index: 1000;
      white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; /* Hide scrollbar */
    }
    nav::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome/Safari */
    
    nav a { 
      color: var(--text-muted); text-decoration: none; padding: 8px 16px; border-radius: 8px; 
      font-size: 0.95rem; transition: 0.2s; background: rgba(255,255,255,0.05);
    }
    nav a:hover { background: #2d3748; color: white; }
    nav a.active { background: rgba(16, 185, 129, 0.15); color: var(--primary); font-weight: 600; border: 1px solid rgba(16, 185, 129, 0.3); }

    /* Main Layout */
    .container { 
      max-width: 1200px; margin: 20px auto; padding: 0 15px; 
      display: grid; grid-template-columns: 380px 1fr; gap: 30px;
    }

    /* Forms Section */
    .forms-wrapper { display: flex; flex-direction: column; gap: 20px; }
    
    .form-card { 
      background: var(--card); padding: 20px; border-radius: 16px; 
      border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }
    .form-card h2 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
    
    label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; margin-top: 12px; }
    
    /* Inputs - Larger for Mobile Touch */
    input { 
      width: 100%; padding: 14px; background: var(--input); border: 1px solid var(--border); 
      color: white; border-radius: 10px; font-size: 16px; /* Prevents zoom on iPhone */
      transition: 0.2s; outline: none; appearance: none;
    }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }

    .btn-submit { 
      width: 100%; padding: 16px; background: var(--primary); color: #000; font-weight: 700; font-size: 1rem;
      border: none; border-radius: 10px; cursor: pointer; margin-top: 25px; transition: 0.2s;
    }
    .btn-submit:active { transform: scale(0.98); opacity: 0.9; }
    .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

    /* List Section */
    .list-header { 
      display: flex; gap: 10px; margin-bottom: 20px; 
      background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border);
      align-items: center;
    }
    .search-input { flex: 1; margin: 0; background: #0f172a; }
    
    .btn-icon { 
      padding: 0 20px; height: 48px; background: var(--secondary); color: white; border: none; 
      border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center;
    }
    .btn-refresh { background: var(--card); border: 1px solid var(--border); color: var(--text-muted); width: 48px; padding: 0; }
    .btn-refresh:active { background: var(--border); color: white; }

    /* Customer Grid */
    .customer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

    .cust-card { 
      background: var(--card); border-radius: 12px; border: 1px solid var(--border); 
      overflow: hidden; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .cust-card::before { content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 4px; background: var(--primary); }

    .cust-header { 
      padding: 12px 15px; border-bottom: 1px solid #334155; background: rgba(0,0,0,0.2);
      display: flex; justify-content: space-between; align-items: center; 
    }
    .cust-info h3 { margin: 0; font-size: 1.1rem; color: white; font-weight: 600; }
    .cust-info small { color: var(--secondary); font-family: monospace; font-size: 0.85rem; letter-spacing: 0.5px; }
    
    .btn-delete { 
      background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); 
      padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold;
    }
    .btn-delete:active { background: var(--danger); color: white; }

    .cust-body { padding: 15px; }
    .contact-row { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 12px; display: flex; gap: 15px; }
    
    .product-badge { 
      background: #0f172a; padding: 10px; border-radius: 8px; border: 1px solid #334155; 
      font-size: 0.9rem; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
    }
    .bal-text { color: var(--danger); font-weight: bold; }
    .paid-text { color: var(--primary); font-weight: bold; }

    /* Responsive Queries */
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; gap: 20px; }
      .forms-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    }

    @media (max-width: 650px) {
      .forms-wrapper { display: flex; flex-direction: column; }
      
      .list-header { flex-direction: column; gap: 10px; padding: 12px; }
      .search-input { width: 100%; }
      .list-header button { width: 100%; height: 45px; }
      .btn-refresh { width: 100%; } /* Make refresh full width on mobile */
      
      .cust-card { margin-bottom: 5px; }
      
      h2 { font-size: 1.1rem; }
      input { padding: 12px; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html">Dashboard</a>
    <a href="customers.html" class="active">Customers</a>
    <a href="entries.html">Entries</a>
    <a href="review.html">Agent Sync</a>
    <a href="report.html">Report</a>
  </nav>

  <div class="container">
    
    <div class="forms-wrapper">
      
      <div class="form-card">
        <h2>üë§ New Customer</h2>
        <input id="newId" placeholder="Customer ID (Unique)*">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input id="newName" placeholder="Full Name*">
          <input id="newPhone" placeholder="Phone Number">
        </div>
        <input id="newPlace" placeholder="City / Place">
        
        <label>Initial Product</label>
        <input id="newProduct" placeholder="Product Name*">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input id="newTotal" type="number" placeholder="Total Price*">
          <input id="newPaid" type="number" placeholder="Down Payment*">
        </div>
        
        <button id="btnAddCustomer" class="btn-submit">Create Profile</button>
      </div>

      <div class="form-card">
        <h2>üì¶ Add Product</h2>
        <label>Existing Customer</label>
        <input id="existId" placeholder="Enter Customer ID*">
        
        <label>New Product Details</label>
        <input id="addProduct" placeholder="Product Name*">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input id="addTotal" type="number" placeholder="Total Price*">
          <input id="addPaid" type="number" placeholder="Down Payment*">
        </div>
        
        <button id="btnAddProduct" class="btn-submit" style="background:var(--secondary);">Add Product</button>
      </div>

    </div>

    <div>
      <div class="list-header">
        <input id="searchBox" class="search-input" placeholder="üîç Search ID or Name...">
        <button class="btn-icon" onclick="searchData()">Search</button>
        <button class="btn-icon btn-refresh" onclick="loadRecent()">üîÑ Refresh</button>
      </div>

      <div id="customerList" class="customer-grid">
        <p style="color:#666; width:100%; text-align:center; padding: 20px;">Loading database...</p>
      </div>
    </div>

  </div>

  <script type="module">
    import { db } from "./config.js";
    import { 
      doc, setDoc, getDoc, updateDoc, deleteDoc, 
      collection, query, where, limit, getDocs, orderBy, 
      runTransaction, increment 
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // --- 1. ADD NEW CUSTOMER ---
    document.getElementById("btnAddCustomer").addEventListener("click", async () => {
      const id = document.getElementById("newId").value.trim();
      const name = document.getElementById("newName").value.trim();
      const product = document.getElementById("newProduct").value.trim();
      const total = parseFloat(document.getElementById("newTotal").value);
      const paid = parseFloat(document.getElementById("newPaid").value);

      if (!id || !name || !product || isNaN(total) || isNaN(paid)) {
        return alert("‚ùå Please fill all required fields marked with *");
      }

      const btn = document.getElementById("btnAddCustomer");
      const originalText = btn.innerText;
      btn.innerText = "Creating...";
      btn.disabled = true;

      try {
        await runTransaction(db, async (transaction) => {
          const custRef = doc(db, "customers", id);
          const statsRef = doc(db, "metadata", "stats");
          
          const check = await transaction.get(custRef);
          if (check.exists()) throw "Customer ID already exists!";

          const newCust = {
            id, name, 
            phone: document.getElementById("newPhone").value.trim(),
            place: document.getElementById("newPlace").value.trim(),
            createdAt: new Date().toISOString(),
            products: [{
              name: product,
              total: total,
              paid: paid,
              payments: [{
                date: new Date().toISOString().split("T")[0],
                amount: paid,
                dueNumber: 0, 
                type: "Downpayment"
              }]
            }]
          };

          transaction.set(custRef, newCust);
          
          const bal = total - paid;
          transaction.set(statsRef, {
            totalCustomers: increment(1),
            totalProducts: increment(1),
            totalPaid: increment(paid),
            totalBalance: increment(bal)
          }, { merge: true });
        });

        alert("‚úÖ Customer Created!");
        clearInputs(["newId", "newName", "newPhone", "newPlace", "newProduct", "newTotal", "newPaid"]);
        loadRecent();

      } catch (e) {
        alert("Error: " + e);
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    });

    // --- 2. ADD PRODUCT TO EXISTING ---
    document.getElementById("btnAddProduct").addEventListener("click", async () => {
      const id = document.getElementById("existId").value.trim();
      const name = document.getElementById("addProduct").value.trim();
      const total = parseFloat(document.getElementById("addTotal").value);
      const paid = parseFloat(document.getElementById("addPaid").value);

      if (!id || !name || isNaN(total)) return alert("‚ùå Check inputs");

      const btn = document.getElementById("btnAddProduct");
      btn.innerText = "Adding...";
      btn.disabled = true;

      try {
        await runTransaction(db, async (transaction) => {
          const custRef = doc(db, "customers", id);
          const statsRef = doc(db, "metadata", "stats");
          
          const docSnap = await transaction.get(custRef);
          if (!docSnap.exists()) throw "Customer not found!";

          const data = docSnap.data();
          const newProd = {
            name, total, paid,
            payments: [{
              date: new Date().toISOString().split("T")[0],
              amount: paid,
              dueNumber: 0,
              type: "Downpayment"
            }]
          };

          data.products.push(newProd);

          transaction.update(custRef, { products: data.products });
          
          const bal = total - paid;
          transaction.update(statsRef, {
            totalProducts: increment(1),
            totalPaid: increment(paid),
            totalBalance: increment(bal)
          });
        });

        alert("‚úÖ Product Added!");
        clearInputs(["existId", "addProduct", "addTotal", "addPaid"]);
        loadRecent();

      } catch (e) {
        alert("Error: " + e);
      } finally {
        btn.innerText = "Add Product";
        btn.disabled = false;
      }
    });

    // --- 3. LOAD & SEARCH ---
    window.loadRecent = async () => {
      const container = document.getElementById("customerList");
      container.innerHTML = `<p style="color:#888; text-align:center;">Fetching recent...</p>`;
      
      try {
        const q = query(collection(db, "customers"), orderBy("createdAt", "desc"), limit(20));
        const snap = await getDocs(q);
        renderList(snap);
      } catch (e) {
        console.error(e);
        container.innerHTML = `<p style="color:red; text-align:center;">Error loading list.</p>`;
      }
    };

    window.searchData = async () => {
      const term = document.getElementById("searchBox").value.trim();
      if (!term) return loadRecent();

      const container = document.getElementById("customerList");
      container.innerHTML = `<p style="color:#aaa; text-align:center;">Searching...</p>`;
      
      try {
        const q = query(
          collection(db, "customers"), 
          where("id", ">=", term), 
          where("id", "<=", term + '\uf8ff'),
          limit(10)
        );
        const snap = await getDocs(q);
        renderList(snap);
      } catch (e) {
        container.innerHTML = `<p style="color:red; text-align:center;">Search Error: ${e.message}</p>`;
      }
    };

    function renderList(snapshot) {
      const container = document.getElementById("customerList");
      container.innerHTML = "";

      if (snapshot.empty) {
        container.innerHTML = "<p style='color:#888; text-align:center;'>No customers found.</p>";
        return;
      }

      snapshot.forEach(docSnap => {
        const c = docSnap.data();
        let prodHTML = "";
        
        c.products.forEach(p => {
          const bal = p.total - p.paid;
          const balText = bal > 0 ? `<span class="bal-text">Bal: ‚Çπ${bal}</span>` : `<span class="paid-text">Paid ‚úî</span>`;
          
          prodHTML += `
            <div class="product-badge">
              <span>üì¶ ${p.name}</span>
              ${balText}
            </div>
          `;
        });

        const div = document.createElement("div");
        div.className = "cust-card";
        div.innerHTML = `
          <div class="cust-header">
            <div class="cust-info">
              <h3>${c.name}</h3>
              <small>ID: ${c.id}</small>
            </div>
            <button class="btn-delete" onclick="deleteCustomer('${c.id}')" title="Delete">üóëÔ∏è</button>
          </div>
          <div class="cust-body">
            <div class="contact-row">
              <span>üìû ${c.phone || '-'}</span>
              <span>üìç ${c.place || '-'}</span>
            </div>
            ${prodHTML}
          </div>
        `;
        container.appendChild(div);
      });
    }

    // --- 4. DELETE CUSTOMER ---
    window.deleteCustomer = async (id) => {
      if (!confirm(`‚ö†Ô∏è DELETE ${id}?\n\nThis will remove the customer and their payment history forever.`)) return;

      try {
        await runTransaction(db, async (transaction) => {
          const custRef = doc(db, "customers", id);
          const statsRef = doc(db, "metadata", "stats");
          
          const snap = await transaction.get(custRef);
          if (!snap.exists()) throw "Customer not found!";
          
          const data = snap.data();
          
          // Stats Logic
          let removePaid = 0;
          let removeBal = 0;
          let removeProds = data.products.length;

          data.products.forEach(p => {
            removePaid += p.paid;
            removeBal += (p.total - p.paid);
          });

          transaction.delete(custRef);

          transaction.update(statsRef, {
            totalCustomers: increment(-1),
            totalProducts: increment(-removeProds),
            totalPaid: increment(-removePaid),
            totalBalance: increment(-removeBal)
          });
        });

        alert("üóëÔ∏è Deleted Successfully");
        loadRecent();

      } catch (e) {
        alert("Error deleting: " + e);
      }
    };

    function clearInputs(ids) {
      ids.forEach(id => document.getElementById(id).value = "");
    }

    // Init
    loadRecent();
    
    window.searchData = searchData;
    window.loadRecent = loadRecent;
    window.deleteCustomer = deleteCustomer;

  </script>
</body>
</html>

